---
import '../styles/base.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StatusBanner from '../components/StatusBanner.astro';
import GuestModeBanner from '../components/GuestModeBanner.tsx';
// Wrapper prevents Astro's renderer probe from triggering hook warnings.
import FeedbackWidgetWrapper from '../components/FeedbackWidgetWrapper.tsx';

interface Props {
  title?: string;
  description?: string;
  noPrint?: string[]; // Classes to hide when printing
}

const {
  title = 'Resilience Hub Toolkit',
  description = 'Local-first tools to organize people, places, and plans before, during, and after disasters.',
  noPrint = [],
} = Astro.props;

// Preserve `noPrint` for upcoming print layout work.
void noPrint;

const canonicalURL = Astro.site ? new URL(Astro.url.pathname, Astro.site) : undefined;
const isPrintMode = Astro.url.searchParams.get('print') === '1';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {canonicalURL && <link rel="canonical" href={canonicalURL} />}

    <!-- Prevent FOUC (Flash of Unstyled Content) for dark mode -->
    <script is:inline>
      // This runs before page renders to prevent flash
      const theme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <meta name="generator" content={Astro.generator} />

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    {canonicalURL && <meta property="og:url" content={canonicalURL} />}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/RHT_orange.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png" />

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#8fd8c3" />

    <title>{title}</title>

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="0270ad49-8b3f-407f-9245-d666a62e5e8c"></script>
  </head>
  <body class="min-h-screen flex flex-col">
    {!isPrintMode && <StatusBanner />}
    {!isPrintMode && <GuestModeBanner client:load />}
    {!isPrintMode && <Header />}

    <main class="flex-1">
      <slot />
    </main>

    {!isPrintMode && <Footer />}

    <!-- Feedback widget -->
    {/* Use wrapper so Astro's renderer-only invocation never runs hooks directly */}
    {!isPrintMode && <FeedbackWidgetWrapper client:load />}

    <script>
      // Register service worker for offline functionality
      // NOTE: Disabled in development to prevent caching issues
      const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

      if ('serviceWorker' in navigator && !isDevelopment) {
        navigator.serviceWorker.register('/sw.js').catch((error) => {
          console.log('Service Worker registration failed:', error);
        });
      } else if (isDevelopment && 'serviceWorker' in navigator) {
        // Unregister service workers in development
        navigator.serviceWorker.getRegistrations().then((registrations) => {
          registrations.forEach((registration) => registration.unregister());
        });
      }

      // Network status detection
      window.addEventListener('online', () => {
        document.dispatchEvent(new CustomEvent('network-status-change', {
          detail: { online: true }
        }));

        // Trigger background sync when coming back online
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'REGISTER_SYNC'
          });
        }
      });

      window.addEventListener('offline', () => {
        document.dispatchEvent(new CustomEvent('network-status-change', {
          detail: { online: false }
        }));
      });

      // Listen for sync messages from service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'SYNC_DATA') {
            console.log('Sync triggered from service worker at:', event.data.timestamp);
            // Dispatch custom event that components can listen to
            document.dispatchEvent(new CustomEvent('background-sync', {
              detail: { timestamp: event.data.timestamp }
            }));
          }
        });
      }
    </script>

    <script>
      // Initialize local storage (no auth checks - app is fully local)
      import { initializeStorage } from '@/lib/storage';

      // Run immediately (IIFE - Immediately Invoked Function Expression)
      (async () => {
        try {
          console.log('[BaseLayout] Initializing local storage (no auth)...');

          // Always initialize in local-only mode
          const { userId } = await initializeStorage();
          console.log('[BaseLayout] Initialized storage:', { userId });
        } catch (error) {
          console.error('[BaseLayout] Failed to initialize storage:', error);
        }
      })();

      /* COMMENTED OUT - Supabase auth check removed
      import { getSession } from '@/lib/supabase';

      (async () => {
        try {
          console.log('[BaseLayout] Checking authentication status...');

          // Check if user is authenticated
          const session = await getSession();

          if (session) {
            console.log('[BaseLayout] User is authenticated, skipping guest mode');
          } else {
            // If not authenticated, initialize guest mode
            console.log('[BaseLayout] User is not authenticated, initializing guest mode...');
            const { userId, isGuest } = await initializeStorage();
            console.log('[BaseLayout] Initialized storage:', { userId, isGuest });
          }
        } catch (error) {
          console.error('[BaseLayout] Failed to initialize storage:', error);
        }
      })();
      */
    </script>
  </body>
</html>
